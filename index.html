<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROZ Voice Bot</title>
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  main{max-width:900px;margin:0 auto;padding:16px}
  .panel{background:#0b1220cc;border:1px solid #22304a;border-radius:18px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button{background:#0b1020;color:#e5e7eb;border:1px solid #2b3b59;border-radius:12px;padding:10px 12px}
  input.grow{flex:1}
  #chat{margin-top:12px;max-height:58vh;overflow:auto;display:flex;flex-direction:column;gap:10px}
  .msg{display:flex}.me .bub{background:#132036}.bot .bub{background:#0b1220}
  .bub{padding:10px 12px;border-radius:14px;border:1px solid #24314f;max-width:80%}
  #player iframe{width:100%;height:250px;border:0;border-radius:12px;margin-top:10px}
  #mic{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:74px;height:74px;border-radius:999px;background:radial-gradient(circle at 30% 20%, rgba(34,211,238,.35), rgba(167,139,250,.35));border:1px solid #2b3b59;font-size:28px}
  #mic.listening{outline:4px solid rgba(34,211,238,.45)}
  #warn{display:none;color:#fca5a5;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<main>
  <div class="panel">
    <div class="row">
      <label>STT:</label>
      <select id="stt">
        <option value="en-IN">English (India)</option>
        <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (India)</option>
      </select>
      <label>TTS:</label>
      <select id="tts"><option value="">Auto</option></select>
      <button id="stop">Stop Speaking</button>
    </div>

    <div id="warn">No Telugu TTS voice found. On Android install/update ‚ÄúSpeech Services by Google‚Äù and download Telugu voice.</div>

    <div class="row" style="margin-top:8px">
      <input id="q" class="grow" placeholder="Say/Type: play Telugu songs ‚Ä¢ weather in Hyderabad ‚Ä¢ who is the prime minister of India" />
      <button id="ask">Ask</button>
    </div>

    <div id="chat"></div>
    <div id="player"><div id="yt-embed"></div></div>
  </div>
</main>

<button id="mic" title="Hold to talk">üé§</button>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
/* ====== CONFIG ====== */
const API_BASE = "https://YOUR-WORKER-SUBDOMAIN.workers.dev"; // <- change this

/* ====== UI refs ====== */
const chat = document.getElementById('chat');
const qIn  = document.getElementById('q');
const btnAsk = document.getElementById('ask');
const btnStop = document.getElementById('stop');
const mic = document.getElementById('mic');
const sttSel = document.getElementById('stt');
const ttsSel = document.getElementById('tts');
const warn = document.getElementById('warn');

/* ====== chat helpers ====== */
function say(kind, text){ const row=document.createElement('div');row.className=`msg ${kind}`;const b=document.createElement('div');b.className='bub';b.textContent=text;row.appendChild(b);chat.appendChild(row);chat.scrollTop=chat.scrollHeight; }

/* ====== speech ====== */
let voices=[];
function loadVoices(){
  voices = speechSynthesis.getVoices()||[];
  const keep = ttsSel.value;
  ttsSel.innerHTML = `<option value="">Auto</option>`;
  voices.forEach(v=>{ const o=document.createElement('option'); o.value=v.name+'||'+v.lang; o.textContent=`${v.name} ‚Äî ${v.lang}`; ttsSel.appendChild(o); });
  warn.style.display = voices.some(v=>/te[-_]/i.test(v.lang)||/Telugu/i.test(v.name)) ? "none" : "block";
  if(keep) ttsSel.value = keep;
}
if('speechSynthesis' in window){ loadVoices(); speechSynthesis.onvoiceschanged=loadVoices; }
function pickVoice(){
  const sel = ttsSel.value;
  if(!sel){
    const tel = voices.find(v=>/te[-_]/i.test(v.lang)||/Telugu/i.test(v.name));
    if(sttSel.value.startsWith('te') && tel) return tel;
    return voices.find(v=>/en[-_]/i.test(v.lang))||voices[0]||null;
  }
  const [n,l]=sel.split('||'); return voices.find(v=>v.name===n&&v.lang===l)||null;
}
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(text); const v=pickVoice(); if(v) u.voice=v,u.lang=v.lang; else u.lang=sttSel.value;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
btnStop.onclick = ()=>speechSynthesis.cancel();

/* ====== API helpers ====== */
async function api(path, params){
  const u = new URL(API_BASE + path);
  Object.entries(params||{}).forEach(([k,v])=>u.searchParams.set(k,v));
  const r = await fetch(u, { headers:{accept:'application/json'} });
  if(!r.ok) throw new Error("API "+path+" failed");
  return r.json();
}

/* ====== YouTube embed by videoId ====== */
let ytReady=false, player=null, lastGesture=0;
function onYouTubeIframeAPIReady(){ ytReady=true; }
function ensurePlayer(){
  if(player || !ytReady) return;
  player = new YT.Player('yt-embed', {
    height:'250', width:'100%',
    playerVars:{autoplay:1,mute:1,playsinline:1,origin:location.origin},
    events:{ onReady:()=>{} }
  });
}
function playVideoId(id){
  ensurePlayer(); if(!player||!player.loadVideoById) return;
  player.loadVideoById(id); setTimeout(()=>{ try{ if(Date.now()-lastGesture<5000) player.unMute(); }catch(e){} }, 500);
}
function stopPlayer(){ if(player&&player.destroy) player.destroy(); player=null; document.getElementById('yt-embed').innerHTML=""; }

/* ====== skills ====== */
function wantsWeather(x){return /weather|‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£/i.test(x)}
function wantsPlay(x){return /play .*song|play telugu|telugu song|‡∞™‡∞æ‡∞ü/i.test(x)}
function wantsStop(x){return /stop music|pause music|close player/i.test(x)}
function wantsTime(x){return /time now|current time|‡∞∏‡∞Æ‡∞Ø‡∞Ç/i.test(x)}
function wantsDate(x){return /today|date today|‡∞§‡±á‡∞¶‡±Ä/i.test(x)}
function wantsHelp(x){return /^help$|what can you do|‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç/i.test(x)}
function smallTalk(x){
  const n=x.toLowerCase();
  if(/how are you|how r u|ela unnaru|meeru ela/.test(n)) return "I‚Äôm good! How can I help you?";
  if(/^hi$|^hello$|namaste|namask/.test(n)) return "Hello! Ask for weather or say: play Telugu songs.";
  if(/your name|‡∞Æ‡±Ä ‡∞™‡±á‡∞∞‡±Å|mee peru/.test(n)) return "I‚Äôm your ROZ voice bot.";
  return null;
}

/* ====== handlers ====== */
async function handle(q){
  if(!q) return; say('me', q);

  const st = smallTalk(q); if(st){ say('bot', st); speak(st); stopPlayer(); return; }
  if(wantsHelp(q)){ const t="I can do: weather, play Telugu songs, time/date, stop/clear, and answer general questions."; say('bot', t); speak(t); stopPlayer(); return; }
  if(wantsStop(q)){ stopPlayer(); const t="Stopped the music."; say('bot', t); speak(t); return; }
  if(wantsTime(q)){ const t="‚è∞ "+new Date().toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'}); say('bot', t); speak(t); return; }
  if(wantsDate(q)){ const t="üìÖ "+new Date().toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'}); say('bot', t); speak(t); return; }

  try{
    if(wantsWeather(q)){
      const city = (q.match(/in\s+([a-zA-Z\s]+)$/i)||[])[1] || "Hyderabad";
      const d = await api("/v1/weather", { city });
      if(d.error){ say('bot',"Sorry, I couldn‚Äôt find that city."); return; }
      const descMap={0:"clear sky",1:"mainly clear",2:"partly cloudy",3:"overcast",45:"foggy",48:"rime fog",51:"light drizzle",53:"drizzle",55:"dense drizzle",61:"light rain",63:"rain",65:"heavy rain",71:"light snow",73:"snow",75:"heavy snow",80:"rain showers",81:"heavy showers",82:"violent showers",95:"thunderstorm",96:"thunder w/ hail",99:"severe thunderstorm"};
      const msg=`Weather in ${d.name}, ${d.country}: ${descMap[d.code]||"moderate"}. Temp ${d.t}¬∞C, feels ${d.tf}¬∞C.`;
      say('bot', msg); speak(msg); stopPlayer(); return;
    }

    if(wantsPlay(q)){
      const name = q.toLowerCase().includes("play") ? q.replace(/.*play/i,"").replace(/song/i,"").trim() : "Telugu songs";
      const res = await api("/v1/music", { q: name || "Telugu songs" });
      if(res.videoId){
        say('bot', `Playing ${name||"Telugu songs"} here.`);
        playVideoId(res.videoId);
        return;
      } else {
        say('bot', "Couldn't find an embeddable result.");
        return;
      }
    }

    // general answer
    const a = await api("/v1/answer", { q });
    if(a && a.answer){
      say('bot', a.answer); speak(a.answer); stopPlayer(); return;
    }
  }catch(e){
    say('bot', "Online service blocked or unavailable.");
    return;
  }

  say('bot', "Say 'help', ask for weather, or say: play Telugu songs.");
  stopPlayer();
}

/* ====== UI wiring ====== */
btnAsk.onclick = ()=>{ lastGesture = Date.now(); handle(qIn.value.trim()); };
qIn.addEventListener('keydown', e=>{ if(e.key==='Enter'){ lastGesture=Date.now(); btnAsk.click(); }});

/* mic press & hold */
let rec=null,listening=false;
if('webkitSpeechRecognition' in window){
  rec = new webkitSpeechRecognition(); rec.continuous=false; rec.interimResults=false;
  rec.onresult = e=>{ const t=e.results[0][0].transcript; handle(t); };
  rec.onend = ()=>{ listening=false; mic.classList.remove('listening'); };
}else{
  say('bot', "‚ö†Ô∏è Mic recognition not supported here. Type your query.");
}
function startRec(){ lastGesture=Date.now(); if(!rec) return; try{ rec.lang=sttSel.value; listening=true; mic.classList.add('listening'); rec.start(); say('bot',"üé§ Listening‚Ä¶"); }catch(e){} }
function stopRec(){ if(rec && listening) rec.stop(); }
mic.onmousedown=startRec; mic.ontouchstart=startRec; mic.onmouseup=stopRec; mic.ontouchend=stopRec; mic.onmouseleave=stopRec;
</script>
</body>
</html>
