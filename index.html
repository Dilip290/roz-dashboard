<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ROZ Voice Bot</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#0f172a;        /* slate-900 */
    --panel:#111827;     /* gray-900 */
    --ink:#e5e7eb;       /* gray-200 */
    --muted:#94a3b8;     /* slate-400 */
    --brand:#22d3ee;     /* cyan-400 */
    --brand2:#a78bfa;    /* violet-400 */
    --card:#0b1220;      /* deep panel */
    --me:#1e293b;        /* slate-800 */
    --bot:#111827;       /* gray-900 */
    --bubble:#0b1220;
    --ring:rgba(34,211,238,.4);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 600px at 10% -10%, rgba(34,211,238,.12), transparent 60%),
      radial-gradient(900px 500px at 100% 0%, rgba(167,139,250,.12), transparent 60%),
      var(--bg);
    color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(6px);
    background:linear-gradient(180deg, rgba(15,23,42,.8), rgba(15,23,42,.4));
    border-bottom:1px solid rgba(148,163,184,.12);
    padding:12px 16px;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .brand .dot{width:10px;height:10px;border-radius:50%;
    background:conic-gradient(from 0deg, var(--brand), var(--brand2), var(--brand)); box-shadow:0 0 16px var(--ring);
  }
  main{max-width:900px;margin:0 auto;padding:16px}
  .panel{
    background:rgba(2,6,23,.6);
    border:1px solid rgba(148,163,184,.18);
    border-radius:18px; padding:16px;
  }
  .rows{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  label{font-size:13px;color:var(--muted)}
  select,input,button{
    background:#0b1020; color:var(--ink); border:1px solid rgba(148,163,184,.2);
    border-radius:12px; padding:10px 12px; font-size:14px;
  }
  select, input{min-height:40px}
  input.grow{flex:1}
  button{cursor:pointer; transition:.15s transform ease}
  button:hover{transform:translateY(-1px)}
  .btn{background:#0b1020}
  .btn-primary{background:linear-gradient(90deg, rgba(34,211,238,.2), rgba(167,139,250,.2));
               border-color:rgba(34,211,238,.4)}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  /* Chat area */
  #chat{
    margin-top:14px; max-height:55vh; overflow:auto; padding:8px 6px;
    display:flex; flex-direction:column; gap:10px;
  }
  .msg{display:flex; gap:10px; align-items:flex-start}
  .bub{
    background:var(--bubble); border:1px solid rgba(148,163,184,.12);
    padding:10px 12px; border-radius:14px; max-width:80%; line-height:1.45;
    box-shadow:0 6px 20px rgba(0,0,0,.18);
  }
  .me .bub{ background:#132036; }
  .bot .bub{ background:#0b1220; }
  .tag{font-size:12px;color:var(--muted)}
  #player iframe{width:100%;height:240px;border:0;border-radius:12px;margin-top:10px}
  /* Floating mic */
  #micFloat{
    position:fixed; right:18px; bottom:18px; z-index:20;
    width:64px;height:64px;border-radius:999px;
    display:flex;align-items:center;justify-content:center;
    background:radial-gradient(circle at 30% 20%, rgba(34,211,238,.35), rgba(167,139,250,.35));
    border:1px solid rgba(148,163,184,.25);
    box-shadow:0 10px 40px rgba(0,0,0,.35);
  }
  #micFloat.listening{ outline:4px solid var(--ring) }
  .sr-only{position:absolute;left:-9999px}
  .row-gap{height:10px}
</style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span><strong>ROZ Voice Bot</strong><span class="tag">browser-only ‚Ä¢ English / ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</span></div>
  </header>

  <main>
    <div class="panel">
      <div class="rows">
        <div>
          <label>STT Language (Mic):</label><br/>
          <select id="sttLang">
            <option value="en-IN">English (India)</option>
            <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (India)</option>
          </select>
        </div>
        <div>
          <label>TTS Voice (Speaker):</label><br/>
          <select id="ttsVoice">
            <option value="">Auto (best match)</option>
          </select>
        </div>
        <div style="flex:1"></div>
        <div>
          <label class="sr-only">Stop Speaking</label><br/>
          <button id="stop" class="btn">Stop Speaking</button>
        </div>
      </div>

      <div class="row-gap"></div>

      <div class="rows">
        <input id="text" class="grow" placeholder="Try: how are you ‚Ä¢ weather in Hyderabad ‚Ä¢ play Telugu songs ‚Ä¢ time now ‚Ä¢ stop music" />
        <button id="send" class="btn-primary">Ask</button>
      </div>

      <div class="hint">Tip: Use Chrome (mobile/desktop). Mic requires HTTPS (GitHub Pages is OK). Pick a **Telugu voice** below if available.</div>

      <div id="chat" aria-live="polite"></div>
      <div id="player"></div>
    </div>
  </main>

  <!-- Floating mic -->
  <button id="micFloat" title="Hold to talk"><span>üé§</span></button>

<script>
/* ---------- Elements ---------- */
const chat = document.getElementById('chat');
const playerDiv = document.getElementById('player');
const sttLangSel = document.getElementById('sttLang');
const ttsVoiceSel = document.getElementById('ttsVoice');
const textIn = document.getElementById('text');
const btnSend = document.getElementById('send');
const btnStop = document.getElementById('stop');
const micFloat = document.getElementById('micFloat');

/* ---------- Persistence ---------- */
(function restore(){
  const L = localStorage.getItem("roz.stt"); if(L) sttLangSel.value = L;
  const V = localStorage.getItem("roz.voice"); if(V) ttsVoiceSel.value = V;
})();
sttLangSel.addEventListener('change', ()=>localStorage.setItem("roz.stt", sttLangSel.value));
ttsVoiceSel.addEventListener('change', ()=>localStorage.setItem("roz.voice", ttsVoiceSel.value));

/* ---------- Chat helpers ---------- */
function addMsg(kind, text){
  const row = document.createElement('div'); row.className = `msg ${kind}`;
  const bub = document.createElement('div'); bub.className = 'bub';
  bub.textContent = text;
  row.appendChild(bub);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

/* ---------- TTS ---------- */
let allVoices = [];
function loadVoices(){
  allVoices = speechSynthesis.getVoices() || [];
  // Rebuild dropdown
  const keep = ttsVoiceSel.value;
  ttsVoiceSel.innerHTML = `<option value="">Auto (best match)</option>`;
  // Group Telugu first if present
  const telugu = allVoices.filter(v=>/te[-_]/i.test(v.lang) || /Telugu/i.test(v.name));
  const english = allVoices.filter(v=>/en[-_]/i.test(v.lang));
  const others = allVoices.filter(v=>!telugu.includes(v) && !english.includes(v));
  function addGroup(label, list){
    if(!list.length) return;
    const grp = document.createElement('optgroup'); grp.label = label;
    list.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v.name + '||' + v.lang;
      opt.textContent = `${v.name} ‚Äî ${v.lang}`;
      ttsVoiceSel.appendChild(opt);
    });
    ttsVoiceSel.appendChild(grp);
  }
  addGroup("Telugu", telugu);
  addGroup("English", english);
  addGroup("Other", others);
  if (keep) ttsVoiceSel.value = keep;
}
if ('speechSynthesis' in window){
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
}

function pickVoice(){
  const sel = ttsVoiceSel.value;
  if(!sel) {
    // Auto: choose Telugu voice if STT lang is te-IN and voice exists; else best English
    const isTel = sttLangSel.value.startsWith('te');
    const tel = allVoices.find(v=>/te[-_]/i.test(v.lang) || /Telugu/i.test(v.name));
    if(isTel && tel) return tel;
    return allVoices.find(v=>/en[-_]/i.test(v.lang)) || allVoices[0] || null;
  }
  const [name, lang] = sel.split('||');
  return allVoices.find(v=>v.name===name && v.lang===lang) || null;
}

function speak(text){
  if(!('speechSynthesis' in window)) return alert('This browser does not support speechSynthesis.');
  const u = new SpeechSynthesisUtterance(text);
  const v = pickVoice();
  if(v) u.voice = v, u.lang = v.lang;
  else u.lang = sttLangSel.value;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
btnStop.onclick = ()=>speechSynthesis.cancel();

/* ---------- Intents ---------- */
function norm(q){ return q.toLowerCase().replace(/\s+/g,' ').trim(); }
function smallTalk(q){
  const n = norm(q);
  if(n.includes("how are you") || n.includes("how r u") || n.includes("ela unnaru") || n.includes("meeru ela"))
    return "I‚Äôm good! How can I help you?";
  if(n==="hi"||n==="hello"||n.includes("namaste")||n.includes("namask"))
    return "Hello! Ask me for weather or say: play Telugu songs.";
  if(n.includes("your name") || q.includes("‡∞Æ‡±Ä ‡∞™‡±á‡∞∞‡±Å") || n.includes("mee peru"))
    return "I‚Äôm your ROZ voice bot.";
  return null;
}
function parseCity(q){
  const mIn = /(?:weather|climate)?\s*in\s+([a-zA-Z\s]+)$/i.exec(q);
  if(mIn && mIn[1]) return mIn[1].trim();
  const mLo = /‡∞≤‡±ã\s*([^\?\.]+)$/i.exec(q);
  if(mLo && mLo[1]) return mLo[1].trim();
  const prev = localStorage.getItem("roz.city");
  return prev || null;
}
function wantsWeather(q){ const n=norm(q); return n.includes("weather") || q.includes("‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£"); }
function wantsPlay(q){ const n=norm(q); return (n.includes("play") && n.includes("song")) || n.includes("telugu song") || q.includes("‡∞™‡∞æ‡∞ü"); }
function wantsTime(q){ const n=norm(q); return n.includes("time now") || n.includes("current time") || q.includes("‡∞∏‡∞Æ‡∞Ø‡∞Ç"); }
function wantsDate(q){ const n=norm(q); return n.includes("today") || n.includes("date today") || q.includes("‡∞§‡±á‡∞¶‡±Ä"); }
function wantsStopMusic(q){ const n=norm(q); return n.includes("stop music") || n.includes("pause music") || n.includes("close player"); }
function wantsClear(q){ const n=norm(q); return n==="clear" || n.includes("clear screen") || n.includes("clear chat") || n.includes("erase"); }
function wantsHelp(q){ const n=norm(q); return n==="help" || n.includes("what can you do") || q.includes("‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç"); }

async function weather(city){
  try{
    if(!city) city = "Hyderabad";
    const g = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`);
    const gj = await g.json();
    if(!gj.results || !gj.results.length) return `Sorry, I couldn‚Äôt find ${city}.`;
    const { latitude, longitude, name, country } = gj.results[0];
    localStorage.setItem("roz.city", name);
    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,weather_code`);
    const wj = await w.json();
    if(!wj.current) return "Weather service returned no data.";
    const t  = Math.round(wj.current.temperature_2m);
    const tf = Math.round(wj.current.apparent_temperature);
    const code = wj.current.weather_code;
    const map = {0:"clear sky",1:"mainly clear",2:"partly cloudy",3:"overcast",45:"foggy",48:"rime fog",
      51:"light drizzle",53:"drizzle",55:"dense drizzle",61:"light rain",63:"rain",65:"heavy rain",
      71:"light snow",73:"snow",75:"heavy snow",80:"rain showers",81:"heavy showers",82:"violent showers",
      95:"thunderstorm",96:"thunder w/ hail",99:"severe thunderstorm"};
    const desc = map[code] || "moderate";
    const te = `${name} ‡∞≤‡±ã ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç: ${desc}. ‡∞â‡∞∑‡±ç‡∞£‡±ã‡∞ó‡±ç‡∞∞‡∞§ ${t}¬∞C, ‡∞Ö‡∞®‡∞ø‡∞™‡∞ø‡∞Ç‡∞ö‡±á ‡∞â‡∞∑‡±ç‡∞£‡±ã‡∞ó‡±ç‡∞∞‡∞§ ${tf}¬∞C.`;
    const en = `Weather in ${name}, ${country}: ${desc}. Temperature ${t}¬∞C, feels like ${tf}¬∞C.`;
    // Speak using chosen voice language:
    const v = pickVoice();
    return (v && /te[-_]/i.test(v.lang)) ? te : en;
  }catch(e){
    return "Weather service not reachable right now.";
  }
}
function youtubeEmbedFor(q){
  const s = encodeURIComponent(q || "Telugu songs");
  return `https://www.youtube-nocookie.com/embed?autoplay=1&mute=0&listType=search&list=${s}`;
}
function stopPlayer(){ playerDiv.innerHTML = ""; }
function tellTime(){ const d=new Date(); return d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'}); }
function tellDate(){ const d=new Date(); return d.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'}); }
function helpText(){
  const v = pickVoice();
  const teAvail = v && /te[-_]/i.test(v.lang);
  return teAvail
    ? "‡∞®‡±á‡∞®‡±Å ‡∞á‡∞µ‡∞ø ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å: 1) ‡∞π‡±å ‡∞Ü‡∞∞‡±ç ‡∞Ø‡±Ç ‚Äî ‡∞®‡±á‡∞®‡±Å ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç ‡∞á‡∞∏‡±ç‡∞§‡∞æ‡∞®‡±Å. 2) ‡∞π‡±à‡∞¶‡∞∞‡∞æ‡∞¨‡∞æ‡∞¶‡±Å ‡∞≤‡±ã ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç. 3) ‡∞™‡±ç‡∞≤‡±á ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å ‡∞™‡∞æ‡∞ü‡∞≤‡±Å. 4) ‡∞ü‡±à‡∞Æ‡±ç ‡∞®‡±å. 5) ‡∞∏‡±ç‡∞ü‡∞æ‡∞™‡±ç ‡∞Æ‡±ç‡∞Ø‡±Ç‡∞ú‡∞ø‡∞ï‡±ç. 6) ‡∞ï‡±ç‡∞≤‡∞ø‡∞Ø‡∞∞‡±ç."
    : "I can do: 1) Small talk (How are you). 2) Weather (e.g., weather in Hyderabad). 3) Play music (play Telugu songs). 4) Time now. 5) Stop music. 6) Clear.";
}

/* ---------- Main handler ---------- */
async function handle(q){
  if(!q) return;
  addMsg('me', q);

  // Help
  if(wantsHelp(q)){ const t = helpText(); addMsg('bot', t); speak(t); stopPlayer(); return; }

  // Small talk
  const st = smallTalk(q);
  if(st){ addMsg('bot', st); speak(st); stopPlayer(); return; }

  // Date/Time
  if(wantsTime(q)){ const t = `‚è∞ ${tellTime()}`; addMsg('bot', t); speak(t); return; }
  if(wantsDate(q)){ const t = `üìÖ ${tellDate()}`; addMsg('bot', t); speak(t); return; }

  // Weather
  if(wantsWeather(q)){
    const say = await weather(parseCity(q));
    addMsg('bot', say); speak(say); stopPlayer(); return;
  }

  // Stop music / Clear
  if(wantsStopMusic(q)){ stopPlayer(); const t = "Stopped the music."; addMsg('bot', t); speak(t); return; }
  if(wantsClear(q)){ chat.innerHTML = ""; stopPlayer(); return; }

  // Play song
  if(wantsPlay(q)){
    let n = q; const i = n.toLowerCase().indexOf("play");
    if(i>=0) n = n.substring(i+4).trim();
    if(!n) n = "Telugu songs";
    const say = `Playing ${n} on YouTube.`;
    addMsg('bot', say); speak(say);
    playerDiv.innerHTML = `<iframe allow="autoplay; encrypted-media" src="${youtubeEmbedFor(n)}"></iframe>`;
    return;
  }

  // Fallback
  const fb = "Say 'help', ask for weather, or say: play Telugu songs.";
  addMsg('bot', fb); speak(fb); stopPlayer();
}

/* ---------- UI ---------- */
btnSend.onclick = ()=>handle(textIn.value.trim());
textIn.addEventListener('keydown', e=>{ if(e.key==='Enter') btnSend.click(); });

/* Speech Recognition */
let rec = null, listening = false;
if('webkitSpeechRecognition' in window){
  rec = new webkitSpeechRecognition();
  rec.continuous = false; rec.interimResults = false;
  rec.onresult = e => { const t = e.results[0][0].transcript; handle(t); };
  rec.onend = ()=>{ listening=false; micFloat.classList.remove('listening'); };
} else {
  // show hint in chat
  addMsg('bot', "‚ö†Ô∏è Your browser doesn‚Äôt support mic recognition. Type your query.");
}

/* Floating mic ‚Äì hold to talk */
function startRec(){
  if(!rec) return;
  try{
    rec.lang = sttLangSel.value;
    listening = true; micFloat.classList.add('listening');
    rec.start(); addMsg('bot', "üé§ Listening‚Ä¶");
  }catch(e){}
}
function stopRec(){ if(rec && listening) rec.stop(); }
micFloat.onmousedown = startRec;  micFloat.ontouchstart = startRec;
micFloat.onmouseup   = stopRec;   micFloat.ontouchend   = stopRec;
micFloat.onmouseleave= stopRec;

/* Warm up voices list */
if('speechSynthesis' in window){
  // trigger voices load on some browsers
  speechSynthesis.getVoices(); 
  setTimeout(loadVoices, 200);
}
</script>
</body>
</html>
