<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ROZ Voice Bot</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
    --brand:#22d3ee; --brand2:#a78bfa; --panel:#0b1220; --ring:rgba(34,211,238,.45);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(34,211,238,.12), transparent 60%),
      radial-gradient(900px 500px at 100% 0%, rgba(167,139,250,.12), transparent 60%),
      #0f172a;
  }
  header{
    position:sticky; top:0; z-index:10; padding:12px 16px;
    backdrop-filter: blur(6px);
    background:linear-gradient(180deg, rgba(15,23,42,.8), rgba(15,23,42,.4));
    border-bottom:1px solid rgba(148,163,184,.12);
  }
  .brand{display:flex;align-items:center;gap:10px}
  .brand .dot{width:10px;height:10px;border-radius:50%;
    background:conic-gradient(from 0deg, var(--brand), var(--brand2), var(--brand)); box-shadow:0 0 16px var(--ring);
  }
  main{max-width:900px;margin:0 auto;padding:16px}
  .panel{background:rgba(2,6,23,.6);border:1px solid rgba(148,163,184,.18);border-radius:18px;padding:16px}
  .rows{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:13px;color:var(--muted)}
  select,input,button{background:#0b1020;color:var(--ink);border:1px solid rgba(148,163,184,.2);border-radius:12px;padding:10px 12px;font-size:14px}
  input.grow{flex:1}
  button{cursor:pointer;transition:.15s transform ease} button:hover{transform:translateY(-1px)}
  .btn-primary{background:linear-gradient(90deg, rgba(34,211,238,.2), rgba(167,139,250,.2));border-color:rgba(34,211,238,.4)}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  #chat{margin-top:14px;max-height:55vh;overflow:auto;padding:8px 6px;display:flex;flex-direction:column;gap:10px}
  .msg{display:flex;gap:10px;align-items:flex-start}
  .bub{background:#0b1220;border:1px solid rgba(148,163,184,.12);padding:10px 12px;border-radius:14px;max-width:80%;line-height:1.45;box-shadow:0 6px 20px rgba(0,0,0,.18)}
  .me .bub{background:#132036}
  .tag{font-size:12px;color:var(--muted)}
  #player iframe{width:100%;height:250px;border:0;border-radius:12px;margin-top:10px}
  /* CENTER mic button */
  #micFloat{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px; z-index:20; width:74px;height:74px;border-radius:999px;
    display:flex;align-items:center;justify-content:center;font-size:28px;
    background:radial-gradient(circle at 30% 20%, rgba(34,211,238,.35), rgba(167,139,250,.35));
    border:1px solid rgba(148,163,184,.25); box-shadow:0 10px 40px rgba(0,0,0,.35);
  }
  #micFloat.listening{ outline:4px solid var(--ring) }
  #ttsWarn{display:none;margin-top:6px;font-size:12px;color:#fca5a5}
</style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span><strong>ROZ Voice Bot</strong><span class="tag">browser-only ‚Ä¢ English / ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</span></div>
  </header>

  <main>
    <div class="panel">
      <div class="rows">
        <div>
          <label>STT Language (Mic):</label><br/>
          <select id="sttLang">
            <option value="en-IN">English (India)</option>
            <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (India)</option>
          </select>
        </div>
        <div>
          <label>TTS Voice (Speaker):</label><br/>
          <select id="ttsVoice">
            <option value="">Auto (best match)</option>
          </select>
        </div>
        <div style="flex:1"></div>
        <div>
          <label class="sr-only">Stop Speaking</label><br/>
          <button id="stop">Stop Speaking</button>
        </div>
      </div>

      <div id="ttsWarn">No Telugu TTS voice found on this device. On Android: install/update ‚ÄúSpeech Services by Google‚Äù ‚Üí download Telugu voice, then refresh this page.</div>

      <div class="rows" style="margin-top:10px">
        <input id="text" class="grow" placeholder="Try: how are you ‚Ä¢ weather in Hyderabad ‚Ä¢ play Telugu songs ‚Ä¢ time now ‚Ä¢ stop music ‚Ä¢ who is APJ Abdul Kalam" />
        <button id="send" class="btn-primary">Ask</button>
      </div>

      <div class="hint">Tip: Hold the mic, speak, and release. For Telugu speech, pick a Telugu voice in the TTS dropdown (Android ‚Üí Speech Services by Google).</div>

      <div id="chat" aria-live="polite"></div>

      <!-- Fixed container for the YouTube API player -->
      <div id="player"><div id="yt-embed"></div></div>
    </div>
  </main>

  <!-- Centered mic -->
  <button id="micFloat" title="Hold to talk">üé§</button>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ===== elements ===== */
const chat = document.getElementById('chat');
const playerDiv = document.getElementById('player');
const sttLangSel = document.getElementById('sttLang');
const ttsVoiceSel = document.getElementById('ttsVoice');
const textIn = document.getElementById('text');
const btnSend = document.getElementById('send');
const btnStop = document.getElementById('stop');
const micFloat = document.getElementById('micFloat');
const ttsWarn = document.getElementById('ttsWarn');

/* ===== persistence ===== */
(function restore(){
  const L = localStorage.getItem("roz.stt"); if(L) sttLangSel.value = L;
  const V = localStorage.getItem("roz.voice"); if(V) ttsVoiceSel.value = V;
})();
sttLangSel.addEventListener('change', ()=>localStorage.setItem("roz.stt", sttLangSel.value));
ttsVoiceSel.addEventListener('change', ()=>localStorage.setItem("roz.voice", ttsVoiceSel.value));

/* ===== chat helpers ===== */
function addMsg(kind, text){
  const row = document.createElement('div'); row.className = `msg ${kind}`;
  const bub = document.createElement('div'); bub.className = 'bub';
  bub.textContent = text; row.appendChild(bub);
  chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
}

/* ===== TTS voices ===== */
let allVoices = [];
function hasTeluguVoice(){ return allVoices.some(v=>/te[-_]/i.test(v.lang) || /Telugu/i.test(v.name)); }
function loadVoices(){
  allVoices = speechSynthesis.getVoices() || [];
  const keep = ttsVoiceSel.value;
  ttsVoiceSel.innerHTML = `<option value="">Auto (best match)</option>`;
  const telugu = allVoices.filter(v=>/te[-_]/i.test(v.lang) || /Telugu/i.test(v.name));
  const english = allVoices.filter(v=>/en[-_]/i.test(v.lang));
  const others  = allVoices.filter(v=>!telugu.includes(v) && !english.includes(v));
  function addGroup(label, list){
    if(!list.length) return;
    const group = document.createElement('optgroup'); group.label = label;
    list.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v.name + '||' + v.lang; opt.textContent = `${v.name} ‚Äî ${v.lang}`;
      group.appendChild(opt);
    });
    ttsVoiceSel.appendChild(group);
  }
  addGroup("Telugu", telugu); addGroup("English", english); addGroup("Other", others);
  if(keep) ttsVoiceSel.value = keep;
  ttsWarn.style.display = hasTeluguVoice() ? "none" : "block";
}
if('speechSynthesis' in window){
  loadVoices(); speechSynthesis.onvoiceschanged = loadVoices;
}
function pickVoice(){
  const sel = ttsVoiceSel.value;
  if(!sel){
    const isTel = sttLangSel.value.startsWith('te');
    const tel = allVoices.find(v=>/te[-_]/i.test(v.lang) || /Telugu/i.test(v.name));
    if(isTel && tel) return tel;
    return allVoices.find(v=>/en[-_]/i.test(v.lang)) || allVoices[0] || null;
  }
  const [name, lang] = sel.split('||');
  return allVoices.find(v=>v.name===name && v.lang===lang) || null;
}
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  const v = pickVoice();
  if(v) u.voice = v, u.lang = v.lang; else u.lang = sttLangSel.value;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
btnStop.onclick = ()=>speechSynthesis.cancel();

/* ===== intents & helpers ===== */
function norm(q){ return q.toLowerCase().replace(/\s+/g,' ').trim(); }
function smallTalk(q){
  const n = norm(q);
  if(n.includes("how are you") || n.includes("how r u") || n.includes("ela unnaru") || n.includes("meeru ela"))
    return "I‚Äôm good! How can I help you?";
  if(n==="hi"||n==="hello"||n.includes("namaste")||n.includes("namask"))
    return "Hello! Ask me for weather or say: play Telugu songs.";
  if(n.includes("your name") || q.includes("‡∞Æ‡±Ä ‡∞™‡±á‡∞∞‡±Å") || n.includes("mee peru"))
    return "I‚Äôm your ROZ voice bot.";
  return null;
}
function parseCity(q){
  const mIn = /(?:weather|climate)?\s*in\s+([a-zA-Z\s]+)$/i.exec(q);
  if(mIn && mIn[1]) return mIn[1].trim();
  const mLo = /‡∞≤‡±ã\s*([^\?\.]+)$/i.exec(q);
  if(mLo && mLo[1]) return mLo[1].trim();
  const prev = localStorage.getItem("roz.city"); return prev || null;
}
function wantsWeather(q){ const n=norm(q); return n.includes("weather") || q.includes("‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£"); }
function wantsPlay(q){ const n=norm(q); return (n.includes("play") && n.includes("song")) || n.includes("telugu song") || q.includes("‡∞™‡∞æ‡∞ü"); }
function wantsTime(q){ const n=norm(q); return n.includes("time now") || n.includes("current time") || q.includes("‡∞∏‡∞Æ‡∞Ø‡∞Ç"); }
function wantsDate(q){ const n=norm(q); return n.includes("today") || n.includes("date today") || q.includes("‡∞§‡±á‡∞¶‡±Ä"); }
function wantsStopMusic(q){ const n=norm(q); return n.includes("stop music") || n.includes("pause music") || n.includes("close player"); }
function wantsClear(q){ const n=norm(q); return n==="clear" || n.includes("clear screen") || n.includes("clear chat") || n.includes("erase"); }
function wantsHelp(q){ const n=norm(q); return n==="help" || n.includes("what can you do") || q.includes("‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç"); }

async function weather(city){
  try{
    if(!city) city = "Hyderabad";
    const g = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`);
    const gj = await g.json();
    if(!gj.results || !gj.results.length) return `Sorry, I couldn‚Äôt find ${city}.`;
    const { latitude, longitude, name, country } = gj.results[0];
    localStorage.setItem("roz.city", name);
    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,weather_code`);
    const wj = await w.json();
    if(!wj.current) return "Weather service returned no data.";
    const t  = Math.round(wj.current.temperature_2m);
    const tf = Math.round(wj.current.apparent_temperature);
    const code = wj.current.weather_code;
    const map = {0:"clear sky",1:"mainly clear",2:"partly cloudy",3:"overcast",45:"foggy",48:"rime fog",
      51:"light drizzle",53:"drizzle",55:"dense drizzle",61:"light rain",63:"rain",65:"heavy rain",
      71:"light snow",73:"snow",75:"heavy snow",80:"rain showers",81:"heavy showers",82:"violent showers",
      95:"thunderstorm",96:"thunder w/ hail",99:"severe thunderstorm"};
    const desc = map[code] || "moderate";
    const te = `${name} ‡∞≤‡±ã ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç: ${desc}. ‡∞â‡∞∑‡±ç‡∞£‡±ã‡∞ó‡±ç‡∞∞‡∞§ ${t}¬∞C, ‡∞Ö‡∞®‡∞ø‡∞™‡∞ø‡∞Ç‡∞ö‡±á ‡∞â‡∞∑‡±ç‡∞£‡±ã‡∞ó‡±ç‡∞∞‡∞§ ${tf}¬∞C.`;
    const en = `Weather in ${name}, ${country}: ${desc}. Temperature ${t}¬∞C, feels like ${tf}¬∞C.`;
    const v = pickVoice();
    return (v && /te[-_]/i.test(v.lang)) ? te : en;
  }catch(e){ return "Weather service not reachable right now."; }
}

/* ===== YouTube player (autoplay in-page) ===== */
let ytReady = false, ytPlayer = null, lastGestureTs = 0;
function onYouTubeIframeAPIReady(){ ytReady = true; }

function ensurePlayer(){
  if(ytPlayer || !ytReady) return;
  ytPlayer = new YT.Player('yt-embed', {
    height: '250', width: '100%',
    playerVars: { autoplay: 1, mute: 1 },
    events: { 'onReady': ()=>{} }
  });
}
function playSearch(q){
  ensurePlayer();
  if(!ytPlayer || !ytPlayer.loadPlaylist){ return; }
  ytPlayer.loadPlaylist({ listType:"search", list:q, index:0, startSeconds:0, suggestedQuality:"default" });
  // unmute only if there was a recent user gesture
  setTimeout(()=>{
    try{
      ytPlayer.playVideo();
      if(Date.now() - lastGestureTs < 5000){ ytPlayer.unMute(); }
    }catch(e){}
  }, 500);
}
function stopPlayer(){
  if(ytPlayer && ytPlayer.destroy){ ytPlayer.destroy(); }
  ytPlayer = null;
  document.getElementById('yt-embed').innerHTML = "";
}

/* ===== Wikipedia live fallback ===== */
async function wikiSummaryByTitle(title){
  try{
    const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`, { headers:{accept:'application/json'} });
    if(!r.ok) return null;
    const j = await r.json();
    return j.extract ? j.extract.split('. ').slice(0,2).join('. ') + '.' : null;
  }catch(e){ return null; }
}
async function wikiAnswer(q){
  // 1) try direct summary
  let ans = await wikiSummaryByTitle(q.replace(/\?+$/,'').trim());
  if(ans) return ans;
  // 2) search for a likely title, then summary
  try{
    const s = await fetch(`https://en.wikipedia.org/w/rest.php/v1/search/title?q=${encodeURIComponent(q)}&limit=1`);
    const sj = await s.json();
    if(sj && sj.pages && sj.pages.length){
      const best = sj.pages[0].title;
      ans = await wikiSummaryByTitle(best);
      if(ans) return ans;
    }
  }catch(e){}
  return null;
}

/* ===== main handler ===== */
function tellTime(){ const d=new Date(); return d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'}); }
function tellDate(){ const d=new Date(); return d.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'}); }
function helpText(){
  const v = pickVoice(), teAvail = v && /te[-_]/i.test(v.lang);
  return teAvail
    ? "‡∞®‡±á‡∞®‡±Å ‡∞á‡∞µ‡∞ø ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å: 1) ‡∞π‡±å ‡∞Ü‡∞∞‡±ç ‡∞Ø‡±Ç. 2) ‡∞π‡±à‡∞¶‡∞∞‡∞æ‡∞¨‡∞æ‡∞¶‡±Å ‡∞≤‡±ã ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç. 3) ‡∞™‡±ç‡∞≤‡±á ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å ‡∞™‡∞æ‡∞ü‡∞≤‡±Å. 4) ‡∞ü‡±à‡∞Æ‡±ç ‡∞®‡±å. 5) ‡∞∏‡±ç‡∞ü‡∞æ‡∞™‡±ç ‡∞Æ‡±ç‡∞Ø‡±Ç‡∞ú‡∞ø‡∞ï‡±ç. 6) ‡∞ï‡±ç‡∞≤‡∞ø‡∞Ø‡∞∞‡±ç. 7) ‡∞µ‡∞ø‡∞ï‡±Ä‡∞™‡±Ä‡∞°‡∞ø‡∞Ø‡∞æ ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞≤‡∞ï‡±Å ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç."
    : "I can do: small talk, weather, play Telugu songs, time/date, stop music, clear, plus general facts from Wikipedia.";
}

async function handle(q){
  if(!q) return;
  addMsg('me', q);

  if(wantsHelp(q)){ const t = helpText(); addMsg('bot', t); speak(t); stopPlayer(); return; }

  const st = smallTalk(q);
  if(st){ addMsg('bot', st); speak(st); stopPlayer(); return; }

  if(wantsTime(q)){ const t = `‚è∞ ${tellTime()}`; addMsg('bot', t); speak(t); return; }
  if(wantsDate(q)){ const t = `üìÖ ${tellDate()}`; addMsg('bot', t); speak(t); return; }

  if(wantsWeather(q)){ const say = await weather(parseCity(q)); addMsg('bot', say); speak(say); stopPlayer(); return; }

  if(wantsStopMusic(q)){ stopPlayer(); const t = "Stopped the music."; addMsg('bot', t); speak(t); return; }
  if(wantsClear(q)){ chat.innerHTML = ""; stopPlayer(); return; }

  if(wantsPlay(q)){
    let n = q; const i = n.toLowerCase().indexOf("play"); if(i>=0) n = n.substring(i+4).trim();
    if(!n) n = "Telugu songs";
    const say = `Playing ${n} here.`; addMsg('bot', say); speak(say);
    playSearch(n);
    return;
  }

  // Wikipedia fallback
  const ans = await wikiAnswer(q);
  if(ans){ addMsg('bot', ans); speak(ans); stopPlayer(); return; }

  const fb = "Say 'help', ask for weather, or say: play Telugu songs.";
  addMsg('bot', fb); speak(fb); stopPlayer();
}

/* ===== UI ===== */
btnSend.onclick = ()=>handle(textIn.value.trim());
textIn.addEventListener('keydown', e=>{ if(e.key==='Enter') btnSend.click(); });

/* speech recognition (press & hold mic) */
let rec=null, listening=false;
if('webkitSpeechRecognition' in window){
  rec = new webkitSpeechRecognition(); rec.continuous=false; rec.interimResults=false;
  rec.onresult = e => { const t = e.results[0][0].transcript; handle(t); };
  rec.onend = ()=>{ listening=false; micFloat.classList.remove('listening'); };
} else {
  addMsg('bot', "‚ö†Ô∏è Your browser doesn‚Äôt support mic recognition. Type your query.");
}
function startRec(){
  lastGestureTs = Date.now(); // mark user gesture for autoplay-unmute
  if(!rec) return;
  try{
    rec.lang = sttLangSel.value;
    listening = true; micFloat.classList.add('listening');
    rec.start(); addMsg('bot', "üé§ Listening‚Ä¶");
  }catch(e){}
}
function stopRec(){ if(rec && listening) rec.stop(); }
micFloat.onmousedown = startRec;  micFloat.ontouchstart = startRec;
micFloat.onmouseup   = stopRec;   micFloat.ontouchend   = stopRec; micFloat.onmouseleave = stopRec;

/* voices warm-up */
if('speechSynthesis' in window){ speechSynthesis.getVoices(); setTimeout(loadVoices, 200); }
</script>
</body>
</html>
