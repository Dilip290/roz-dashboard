<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ROZ Voice Bot</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{ --bg:#fff; --ink:#111; --muted:#666; --card:#f5f7fb; --ring:#0ea5e9; }
  *{ box-sizing:border-box }
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{padding:16px;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff;z-index:10}
  main{max-width:820px;margin:0 auto;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button,select,input{padding:12px 14px;border:1px solid #ddd;border-radius:12px;background:#fff;font-size:16px}
  button{cursor:pointer}
  #talk{background:var(--ring);color:#fff;border-color:var(--ring)}
  #stop{background:#f3f4f6}
  #log{margin-top:14px;background:var(--card);border-radius:14px;padding:12px;min-height:150px;white-space:pre-wrap}
  iframe{width:100%;height:260px;border:0;border-radius:12px;margin-top:10px}
  .hint{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;padding:6px 10px;border:1px solid #eee;border-radius:999px;background:#fafafa;margin:2px}
  .listening{outline:3px solid var(--ring); box-shadow:0 0 0 4px rgba(14,165,233,.1)}
  .grow{flex:1}
  a.back{margin-left:auto;text-decoration:none;border:1px solid #eee;border-radius:12px;padding:6px 10px;color:#333}
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>üéôÔ∏è ROZ Voice Bot</strong>
    <span class="pill">no install</span><span class="pill">GitHub Pages</span><span class="pill">English/‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</span>
    <a href="./" class="back">‚Üê Back</a>
  </div>
</header>

<main>
  <div class="row" id="controls">
    <label for="lang">Language:</label>
    <select id="lang">
      <option value="en-IN">English (India)</option>
      <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (India)</option>
    </select>
    <button id="talk">Hold to Talk</button>
    <button id="stop">Stop Speaking</button>
  </div>

  <div class="row" style="margin-top:8px">
    <input id="text" class="grow" placeholder="Ask: how are you ‚Ä¢ weather in Hyderabad ‚Ä¢ play Telugu songs ‚Ä¢ time now ‚Ä¢ stop music" />
    <button id="send">Ask</button>
  </div>
  <div class="hint">Tip: Use Chrome on mobile/desktop. Mic needs HTTPS (GitHub Pages is OK).</div>

  <div id="log"></div>
  <div id="player"></div>
</main>

<script>
/* ---------- Elements ---------- */
const logBox = document.getElementById('log');
const playerDiv = document.getElementById('player');
const langSel  = document.getElementById('lang');
const textIn   = document.getElementById('text');
const btnSend  = document.getElementById('send');
const btnTalk  = document.getElementById('talk');
const btnStop  = document.getElementById('stop');
const controls = document.getElementById('controls');

/* ---------- Persistence (language & last city) ---------- */
(function restorePrefs(){
  const L = localStorage.getItem("roz.lang");
  if(L) langSel.value = L;
})();
langSel.addEventListener('change', ()=>localStorage.setItem("roz.lang", langSel.value));

/* ---------- Logging & Speaking ---------- */
function log(m){ logBox.textContent += m + "\n"; logBox.scrollTop = logBox.scrollHeight; }

function pickVoiceFor(langCode){
  const voices = speechSynthesis.getVoices();
  // Prefer exact language match (e.g., te-IN), else first voice of that language family
  let v = voices.find(v=>v.lang===langCode) || voices.find(v=>v.lang.startsWith(langCode.slice(0,2)));
  return v || null;
}

function speak(txt){
  if(!window.speechSynthesis) return alert("Speech Synthesis not supported in this browser.");
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = langSel.value;
  const pref = pickVoiceFor(u.lang);
  if(pref) u.voice = pref;
  window.speechSynthesis.cancel(); // stop anything pending
  window.speechSynthesis.speak(u);
}
btnStop.onclick = ()=>window.speechSynthesis.cancel();
speechSynthesis.onvoiceschanged = ()=>{}; // ensure voices are populated on some browsers

/* ---------- Helpers ---------- */
function norm(q){ return q.toLowerCase().replace(/\s+/g,' ').trim(); }

function smallTalk(q){
  const n = norm(q);
  if(n.includes("how are you") || n.includes("how r u") || n.includes("ela unnaru") || n.includes("meeru ela"))
    return "I‚Äôm good! How can I help you?";
  if(n==="hi"||n==="hello"||n.includes("namaste")||n.includes("namask"))
    return "Hello! Ask me for weather or say: play Telugu songs.";
  if(n.includes("your name") || q.includes("‡∞Æ‡±Ä ‡∞™‡±á‡∞∞‡±Å") || n.includes("mee peru"))
    return "I‚Äôm your ROZ voice bot.";
  return null;
}

function parseCity(q){
  // Try to capture text after "in" or Telugu "lo" including multi-word names
  // e.g., "weather in new york city" -> "new york city"
  const mIn = /(?:weather|climate)?\s*in\s+([a-zA-Z\s]+)$/i.exec(q);
  if(mIn && mIn[1]) return mIn[1].trim();
  const mLo = /‡∞≤‡±ã\s*([^\?\.]+)$/i.exec(q); // Telugu "lo ..."
  if(mLo && mLo[1]) return mLo[1].trim();
  // Fallback to previous saved city
  const prev = localStorage.getItem("roz.city");
  return prev || null;
}
function saveCity(name){ if(name) localStorage.setItem("roz.city", name); }

function wantsWeather(q){ const n=norm(q); return n.includes("weather") || q.includes("‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£"); }
function wantsPlay(q){ const n=norm(q); return (n.includes("play") && n.includes("song")) || n.includes("telugu song") || q.includes("‡∞™‡∞æ‡∞ü"); }
function wantsTime(q){ const n=norm(q); return n.includes("time now") || n.includes("current time") || q.includes("‡∞∏‡∞Æ‡∞Ø‡∞Ç"); }
function wantsDate(q){ const n=norm(q); return n.includes("today") || n.includes("date today") || q.includes("‡∞§‡±á‡∞¶‡±Ä"); }
function wantsStopMusic(q){ const n=norm(q); return n.includes("stop music") || n.includes("pause music") || n.includes("close player"); }
function wantsClear(q){ const n=norm(q); return n==="clear" || n.includes("clear screen") || n.includes("clear chat") || n.includes("erase"); }
function wantsHelp(q){ const n=norm(q); return n==="help" || n.includes("what can you do") || q.includes("‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç"); }

async function weather(city){
  try{
    if(!city) city = "Hyderabad";
    const g = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`);
    const gj = await g.json();
    if(!gj.results || !gj.results.length) return `Sorry, I couldn‚Äôt find ${city}.`;
    const { latitude, longitude, name, country } = gj.results[0];
    saveCity(name);
    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,weather_code`);
    const wj = await w.json();
    if(!wj.current) return "Weather service returned no data.";
    const t  = Math.round(wj.current.temperature_2m);
    const tf = Math.round(wj.current.apparent_temperature);
    const code = wj.current.weather_code;
    const desc = ({
      0:"clear sky",1:"mainly clear",2:"partly cloudy",3:"overcast",
      45:"foggy",48:"rime fog",51:"light drizzle",53:"drizzle",55:"dense drizzle",
      61:"light rain",63:"rain",65:"heavy rain",71:"light snow",73:"snow",75:"heavy snow",
      80:"rain showers",81:"heavy showers",82:"violent showers",95:"thunderstorm",
      96:"thunder w/ hail",99:"severe thunderstorm"
    })[code] || "moderate";
    return langSel.value.startsWith("te")
      ? `${name} ‡∞≤‡±ã ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç: ${desc}. ‡∞â‡∞∑‡±ç‡∞£‡±ã‡∞ó‡±ç‡∞∞‡∞§ ${t}¬∞C, ‡∞Ö‡∞®‡∞ø‡∞™‡∞ø‡∞Ç‡∞ö‡±á ‡∞â‡∞∑‡±ç‡∞£‡±ã‡∞ó‡±ç‡∞∞‡∞§ ${tf}¬∞C.`
      : `Weather in ${name}, ${country}: ${desc}. Temperature ${t}¬∞C, feels like ${tf}¬∞C.`;
  }catch(e){
    return "Weather service not reachable right now.";
  }
}

function youtubeEmbedFor(q){
  const s = encodeURIComponent(q || "Telugu songs");
  return `https://www.youtube-nocookie.com/embed?autoplay=1&mute=0&listType=search&list=${s}`;
}
function stopPlayer(){ playerDiv.innerHTML = ""; }

function tellTime(){
  const d = new Date();
  const opts = { hour: 'numeric', minute: '2-digit' };
  return d.toLocaleTimeString(undefined, opts);
}
function tellDate(){
  const d = new Date();
  const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
  return d.toLocaleDateString(undefined, opts);
}

function helpText(){
  return langSel.value.startsWith("te")
    ? "‡∞®‡±á‡∞®‡±Å ‡∞á‡∞µ‡∞ø ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å: 1) ‡∞π‡±å ‡∞Ü‡∞∞‡±ç ‡∞Ø‡±Ç ‚Äî ‡∞®‡±á‡∞®‡±Å ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç ‡∞á‡∞∏‡±ç‡∞§‡∞æ‡∞®‡±Å. 2) ‡∞π‡±à‡∞¶‡∞∞‡∞æ‡∞¨‡∞æ‡∞¶‡±Å ‡∞≤‡±ã ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç ‚Äî ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç ‡∞ö‡±Ü‡∞¨‡±Å‡∞§‡∞æ‡∞®‡±Å. 3) ‡∞™‡±ç‡∞≤‡±á ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å ‡∞™‡∞æ‡∞ü‡∞≤‡±Å ‚Äî ‡∞Ø‡±Ç‡∞ü‡±ç‡∞Ø‡±Ç‡∞¨‡±ç ‡∞≤‡±ã ‡∞™‡±ç‡∞≤‡±á ‡∞ö‡±á‡∞∏‡±ç‡∞§‡∞æ‡∞®‡±Å. 4) ‡∞ü‡±à‡∞Æ‡±ç ‡∞®‡±å ‚Äî ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞∏‡∞Æ‡∞Ø‡∞Ç. 5) ‡∞∏‡±ç‡∞ü‡∞æ‡∞™‡±ç ‡∞Æ‡±ç‡∞Ø‡±Ç‡∞ú‡∞ø‡∞ï‡±ç ‚Äî ‡∞™‡±ç‡∞≤‡±á‡∞Ø‡∞∞‡±ç ‡∞Æ‡±Ç‡∞∏‡±á‡∞∏‡±ç‡∞§‡∞æ‡∞®‡±Å. 6) ‡∞ï‡±ç‡∞≤‡∞ø‡∞Ø‡∞∞‡±ç ‚Äî ‡∞∏‡±ç‡∞ï‡±ç‡∞∞‡±Ä‡∞®‡±ç ‡∞ï‡±ç‡∞≤‡∞ø‡∞Ø‡∞∞‡±ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡∞æ‡∞®‡±Å."
    : "I can do: 1) Small talk (How are you). 2) Weather (e.g., weather in Hyderabad). 3) Play music (play Telugu songs). 4) Time now. 5) Stop music. 6) Clear screen.";
}

/* ---------- Main handler ---------- */
async function handle(q){
  if(!q) return;
  log("üßë You: " + q);

  // Help
  if(wantsHelp(q)){ const t = helpText(); log("ü§ñ Bot: " + t); speak(t); stopPlayer(); return; }

  // Small talk
  const st = smallTalk(q);
  if(st){ log("ü§ñ Bot: " + st); speak(st); stopPlayer(); return; }

  // Date/Time
  if(wantsTime(q)){ const t = langSel.value.startsWith("te") ? `‡∞á‡∞™‡±ç‡∞™‡∞ü‡∞ø ‡∞∏‡∞Æ‡∞Ø‡∞Ç ${tellTime()}` : `The time is ${tellTime()}.`; log("ü§ñ Bot: "+t); speak(t); return; }
  if(wantsDate(q)){ const t = langSel.value.startsWith("te") ? `‡∞à ‡∞∞‡±ã‡∞ú‡±Å ${tellDate()}` : `Today is ${tellDate()}.`; log("ü§ñ Bot: "+t); speak(t); return; }

  // Weather
  if(wantsWeather(q)){
    const say = await weather(parseCity(q));
    log("ü§ñ Bot: " + say); speak(say); stopPlayer(); return;
  }

  // Stop music / Clear
  if(wantsStopMusic(q)){ stopPlayer(); const t = langSel.value.startsWith("te") ? "‡∞Æ‡±ç‡∞Ø‡±Ç‡∞ú‡∞ø‡∞ï‡±ç ‡∞Ü‡∞™‡±á‡∞∂‡∞æ‡∞®‡±Å." : "Stopped the music."; log("ü§ñ Bot: "+t); speak(t); return; }
  if(wantsClear(q)){ logBox.textContent = ""; stopPlayer(); return; }

  // Play song
  if(wantsPlay(q)){
    let n = q;
    const i = n.toLowerCase().indexOf("play");
    if(i>=0) n = n.substring(i+4).trim();
    if(!n) n = "Telugu songs";
    const say = langSel.value.startsWith("te") ? `${n} ‡∞™‡±ç‡∞≤‡±á ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å.` : `Playing ${n} on YouTube.`;
    log("ü§ñ Bot: " + say); speak(say);
    playerDiv.innerHTML = `<iframe allow="autoplay; encrypted-media" src="${youtubeEmbedFor(n)}"></iframe>`;
    return;
  }

  // Fallback
  const fb = langSel.value.startsWith("te")
    ? "‡∞Ö‡∞¶‡∞ø ‡∞Ö‡∞∞‡±ç‡∞•‡∞Ç ‡∞ï‡∞æ‡∞≤‡±á‡∞¶‡±Å. '‡∞π‡±Ü‡∞≤‡±ç‡∞™‡±ç' ‡∞Ö‡∞®‡∞ø ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞Ç‡∞°‡∞ø ‡∞≤‡±á‡∞¶‡∞æ ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø ‡∞≤‡±á‡∞¶‡∞æ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å ‡∞™‡∞æ‡∞ü‡∞≤‡±Å ‡∞™‡±ç‡∞≤‡±á ‡∞ö‡±á‡∞Ø‡∞Æ‡∞®‡∞ø ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞Ç‡∞°‡∞ø."
    : "I didn‚Äôt get that. Say 'help', ask for weather, or say: play Telugu songs.";
  log("ü§ñ Bot: " + fb); speak(fb); stopPlayer();
}

/* ---------- UI wiring ---------- */
btnSend.onclick = ()=>handle(textIn.value.trim());

let rec, listening=false, sttSupported = ('webkitSpeechRecognition' in window);
if(sttSupported){
  rec = new webkitSpeechRecognition();
  rec.continuous=false; rec.interimResults=false;
  rec.onresult = e => { const t = e.results[0][0].transcript; handle(t); };
  rec.onend = ()=> { listening=false; controls.classList.remove('listening'); };
} else {
  btnTalk.disabled = true;
  log("‚ö†Ô∏è Your browser doesn‚Äôt support speech recognition. Type your query.");
}

function startRec(){
  if(!rec) return;
  try{
    rec.lang = langSel.value;
    listening = true; controls.classList.add('listening');
    rec.start(); log("üé§ (listening)");
  }catch(e){ /* ignore */ }
}
function stopRec(){
  if(rec && listening){
    rec.stop();
  }
}
btnTalk.onmousedown = startRec;  btnTalk.ontouchstart = startRec;
btnTalk.onmouseup   = stopRec;   btnTalk.ontouchend   = stopRec; btnTalk.onmouseleave = stopRec;

/* Keyboard: Enter to send */
textIn.addEventListener('keydown', (e)=>{ if(e.key==="Enter"){ btnSend.click(); }});
</script>
</body>
</html>
